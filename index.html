<!doctype html>
<html>
  <head>
    <title>Will I Get Fired</title>
    <link rel="stylesheet" href="style.css" >
  </head>
  <body>
    <ul id="messages"></ul>
    <form action="">
      <input id="m" autocomplete="off" placeholder="If I ..."/><button>Will I Get Fired?</button>
    </form>
    <script src="https://cdn.firebase.com/js/client/2.4.0/firebase.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>

    	var ref = new Firebase('https://willigetfired.firebaseio.com/messages');

    	ref.on('value', function (snapshot) {
    		var messages = snapshot.val();

    		if(!messages) return;

    		$('#messages').empty();

    		for(var key in messages) {
    			var msg = messages[key];
    			msg.id = key;
    			console.log('MESSAGE:', msg);
    			if(msg.votes) {
	    			msg.yesVotes = Object.keys(msg.votes).filter(function (k) { return msg.votes[k] === 'y' }).length;
	    			msg.noVotes = Object.keys(msg.votes).filter(function (k) { return msg.votes[k] === 'n' }).length;
	    		} else {
	    			msg.yesVotes = 0;
	    			msg.noVotes = 0;
	    		}
    			renderMessage(msg);
    		}
    	});

      // var socket = io();
      $('form').submit(function(){
      	ref.push({ message: $('#m').val()});
        $('#m').val('');
        return false;
      });
	
	function formatMessage(msg){
		return msg.message + '(Yes Votes:'+ msg.yesVotes +', No Votes:'+ msg.noVotes +' )';
	}
	function renderMessage(msg){
		var totalVotes = (msg.yesVotes + msg.noVotes);
		var percent = totalVotes === 0 ? 0 : (msg.yesVotes / totalVotes * 100);
		$('#messages')
			.prepend($('<li>').css({width: '100%', maxWidth: '500px;'})
				.append($('<label>')
					.attr('id',msg.id).text(formatMessage(msg)))
				.append($('<div>').css({width: '100%', height:'15px', border: '1px solid black'})
					   .append($('<div>').css({width: percent+'%', height:'15px', backgroundColor: 'red'})
							   			.attr('class','progress')
					   )
					)
				.append($('<div>')
					.append($('<button>').text('Yes')
					.click(function(){
						ref.child(msg.id).child('votes').push('y');
						// socket.emit('vote', { id:msg.id,vote:"yes"});
					}))
					.append($('<button>').text('No')
					.click(function(){
						ref.child(msg.id).child('votes').push('n');
						// socket.emit('vote', {id:+msg.id,vote:"no"});
					}))
				)
			);
		
	}
    </script>
  </body>
</html>
